name: Refresh Docs Snapshot

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Tooling
        uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd
        with:
          install: true
          cache: true
          experimental: true
        env:
          # Required for aqua-backed tool installs to avoid GitHub API rate limits in CI.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Refresh docs parquet
        run: |
          mise run setup
          mkdir -p .memory
          DOCS_SUMMARY_PATH=.memory/docs-refresh-summary.json bun run src/docs/fetch-cli.ts

      - name: Build PR body
        run: |
          node <<'NODE'
          const fs = require('fs');

          const summaryPath = '.memory/docs-refresh-summary.json';
          const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
          const sha = process.env.GITHUB_SHA || 'unknown';
          const shortSha = sha.slice(0, 12);
          const generatedAt = summary.generatedAt || new Date().toISOString();

          const body = [
            '## Docs Snapshot Refresh',
            '',
            `- Source commit: \`${shortSha}\``,
            `- Generated at: \`${generatedAt}\``,
            `- Total pages discovered: ${summary.totalPages}`,
            `- Pages fetched: ${summary.fetchedPages}`,
            `- Pages failed: ${summary.failedPages}`,
            '',
            'This PR was generated by the manual `Refresh Docs Snapshot` workflow.',
          ].join('\n');

          fs.writeFileSync('.memory/docs-refresh-pr-body.md', `${body}\n`, 'utf8');
          NODE

      - name: Create pull request
        uses: peter-evans/create-pull-request@v7
        with:
          branch: chore/refresh-docs-snapshot
          title: 'chore(data): refresh docs snapshot'
          commit-message: 'chore(data): refresh docs snapshot'
          body-path: .memory/docs-refresh-pr-body.md
          delete-branch: true
          add-paths: |
            data/docs.parquet
